<!DOCTYPE html>
<html>
<head>
    <title>Stream Test</title>
</head>
<body>
    <h1>Stream Test</h1>
    <div id="output"></div>
    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            output.innerHTML += `<div>${message}</div>`;
        }
        
        async function testStream() {
            log('Starting stream test...');
            
            const response = await fetch('http://localhost:8001/api/v1/workflows/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    "flow_data": {
                        "nodes": [
                            {
                                "id": "start-1",
                                "type": "StartNode",
                                "position": {"x": 100, "y": 100},
                                "data": {"label": "Start"}
                            },
                            {
                                "id": "end-1",
                                "type": "EndNode",
                                "position": {"x": 300, "y": 100},
                                "data": {"label": "End"}
                            }
                        ],
                        "edges": [
                            {
                                "id": "e1-2",
                                "source": "start-1",
                                "target": "end-1"
                            }
                        ]
                    },
                    "input_text": "Hello test"
                })
            });
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const jsonData = JSON.parse(line.slice(6));
                            log(`üì° Chunk: ${JSON.stringify(jsonData)}`);
                            
                            if (jsonData.type === 'complete') {
                                log(`üéØ Complete found: ${jsonData.result}`);
                            }
                        } catch (e) {
                            log(`‚ùå Parse error: ${line}`);
                        }
                    }
                }
            }
            
            log('Stream test completed');
        }
        
        testStream().catch(error => {
            log(`‚ùå Error: ${error.message}`);
        });
    </script>
</body>
</html>